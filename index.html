<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashfix Trust Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.7",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

<script type="module">
import React, { useState, useEffect } from 'react';
import { createRoot } from 'react-dom/client';
import { createClient } from '@supabase/supabase-js';
import { 
  Zap, ShieldCheck, Camera, Upload, Lock, RefreshCw, 
  Smartphone, Briefcase, Check, MapPin, Server, Activity 
} from 'lucide-react';
// --- 1. CONFIGURATION ---

// FIXED: Added quotes and formatted the URL correctly
const SUPABASE_URL = 'https://yfsozkelofdrnyondmwa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlmc296a2Vsb2Zkcm55b25kbXdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzM4NjgsImV4cCI6MjA4NjUwOTg2OH0.5XC0G3qUTi50-Em1uvEIQYMUxfTcHd8BOrb35rZUquo';

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);



// --- 2. LOGIC LAYERS ---

class TrustProtocol {
  static async processEvidence(file) {
    // 1. Cryptographic Hashing (SHA-256)
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
    return {
      hash: hashHex,
      timestamp: new Date().toISOString(),
      verified: true
    };
  }
}

// --- 3. REACT COMPONENTS ---

const StatusBadge = ({ label, status }) => {
  const colors = {
    pending: 'text-slate-400 bg-slate-50',
    loading: 'text-blue-600 bg-blue-50 animate-pulse',
    success: 'text-green-600 bg-green-50'
  };
  return (
    <div className={`flex items-center gap-3 p-3 rounded-lg border border-transparent ${colors[status]} mb-2 transition-all`}>
      {status === 'loading' ? <RefreshCw size={16} className="animate-spin" /> : <Check size={16} />}
      <span className="text-sm font-bold">{label}</span>
    </div>
  );
};

const TechnicianView = ({ onComplete }) => {
  const [file, setFile] = useState(null);
  const [preview, setPreview] = useState(null);
  const [status, setStatus] = useState('idle');
  const [steps, setSteps] = useState({ exif: 'pending', gps: 'pending', hash: 'pending' });

  const handleFile = (e) => {
    if (e.target.files?.[0]) {
      const f = e.target.files[0];
      setFile(f);
      setPreview(URL.createObjectURL(f));
    }
  };

  const runProtocol = async () => {
    if (!file) return;
    setStatus('processing');
    
    setSteps(s => ({ ...s, exif: 'loading' })); await new Promise(r => setTimeout(r, 600));
    setSteps(s => ({ ...s, exif: 'success', gps: 'loading' })); await new Promise(r => setTimeout(r, 800));
    setSteps(s => ({ ...s, gps: 'success', hash: 'loading' }));
    
    const proof = await TrustProtocol.processEvidence(file);
    setSteps(s => ({ ...s, hash: 'success' }));

    await new Promise(r => setTimeout(r, 500));
    setStatus('done');
    onComplete(proof, file, preview);
  };

  return (
    <div className="bg-white rounded-3xl p-6 shadow-xl border border-slate-200">
      <h2 className="font-bold mb-4 flex items-center gap-2"><Camera className="text-indigo-500"/> Evidence Capture</h2>
      {!file ? (
        <label className="block w-full aspect-video rounded-2xl border-2 border-dashed border-slate-300 hover:border-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer flex flex-col items-center justify-center gap-3 group">
          <input type="file" accept="image/*" onChange={handleFile} className="hidden" />
          <Upload className="text-slate-400 group-hover:text-indigo-500" size={32} />
          <span className="text-slate-500 font-medium">Upload Site Photo</span>
        </label>
      ) : (
        <div className="space-y-4">
          <div className="relative rounded-2xl overflow-hidden aspect-video bg-slate-900">
            <img src={preview} className="w-full h-full object-cover opacity-90" />
            {status === 'done' && <div className="absolute inset-0 bg-green-500/90 flex items-center justify-center flex-col text-white"><ShieldCheck size={48}/><span className="font-bold mt-2">VERIFIED</span></div>}
          </div>
          {status === 'idle' ? (
            <button onClick={runProtocol} className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-black transition-all">
              <Lock size={18} /> Run Trust Protocol
            </button>
          ) : status !== 'done' && (
            <div className="bg-slate-50 rounded-xl p-2">
              <StatusBadge label="Metadata Extraction" status={steps.exif} />
              <StatusBadge label="GPS Geofence Match" status={steps.gps} />
              <StatusBadge label="SHA-256 Hashing" status={steps.hash} />
            </div>
          )}
        </div>
      )}
    </div>
  );
};

const InvestorView = ({ jobs }) => {
  return (
    <div className="space-y-6">
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
          <p className="text-xs text-slate-500 font-bold uppercase mb-1">Verified Jobs</p>
          <p className="text-4xl font-black text-slate-900">{jobs.length}</p>
        </div>
        <div className="bg-indigo-600 p-5 rounded-2xl border border-indigo-500 shadow-sm text-white">
          <p className="text-xs text-indigo-200 font-bold uppercase mb-1">Est. Value</p>
          <p className="text-4xl font-black">${jobs.length * 250}</p>
        </div>
      </div>

      <div className="space-y-4">
        <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider ml-1">Live Database Feed</h3>
        {jobs.length === 0 ? (
            <div className="text-center py-8 text-slate-400 bg-slate-100 rounded-xl">No verified jobs in database yet.</div>
        ) : jobs.map((job) => (
            <div key={job.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm animate-in">
              <div className="flex justify-between items-start mb-2">
                <h4 className="font-bold text-slate-900">{job.title || 'Turnover Service'}</h4>
                <span className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1">
                  <ShieldCheck size={10} /> VERIFIED
                </span>
              </div>
              <p className="text-xs text-slate-500 font-mono mb-2 truncate">ID: {job.id}</p>
              <div className="bg-slate-50 rounded p-2 text-[10px] font-mono text-slate-400 truncate">
                HASH: {job.proof_hash || 'Pending...'}
              </div>
            </div>
          ))}
      </div>
    </div>
  );
};

const App = () => {
  const [role, setRole] = useState('tech');
  const [jobs, setJobs] = useState([]);

  // FETCH JOBS FROM SUPABASE
  const fetchJobs = async () => {
    const { data, error } = await supabase.from('jobs').select('*').order('created_at', { ascending: false });
    if (data) setJobs(data);
  };

  useEffect(() => {
    fetchJobs();
    // Subscribe to realtime changes
    const channel = supabase.channel('realtime_jobs')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'jobs' }, 
      (payload) => {
        setJobs((current) => [payload.new, ...current]);
      })
      .subscribe();
      
    return () => { supabase.removeChannel(channel); }
  }, []);

  // SAVE JOB TO SUPABASE
  const handleJobComplete = async (proof, file, preview) => {
    const newJob = {
      title: 'Unit Turnover #' + Math.floor(Math.random() * 1000),
      location: 'Springfield, MO',
      price: 250,
      status: 'verified',
      proof_hash: proof.hash,
      // In a real app, we would upload the image to Supabase Storage here.
      // For MVP, we skip image upload to keep it simple.
    };

    const { error } = await supabase.from('jobs').insert([newJob]);
    
    if (error) {
      alert("Error saving to database: " + error.message);
    } else {
      setTimeout(() => setRole('investor'), 1000); // Switch view to show new row
    }
  };

  return (
    <div className="min-h-screen max-w-md mx-auto bg-slate-50 shadow-2xl overflow-hidden min-h-screen relative">
      <header className="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200 px-4 py-3 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <div className="bg-yellow-400 p-1.5 rounded-lg"><Zap size={20} className="text-slate-900 fill-current"/></div>
          <span className="font-black text-lg uppercase tracking-tight">Flashfix DB</span>
        </div>
        <div className="flex bg-slate-100 p-1 rounded-full">
          <button onClick={() => setRole('tech')} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${role === 'tech' ? 'bg-white shadow-sm' : 'text-slate-500'}`}>Tech</button>
          <button onClick={() => setRole('investor')} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${role === 'investor' ? 'bg-white shadow-sm' : 'text-slate-500'}`}>Investor</button>
        </div>
      </header>

      <main className="p-4 pb-20">
        {role === 'tech' ? (
          <div className="space-y-6 animate-in">
             <div className="bg-indigo-600 text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
               <div className="absolute top-0 right-0 p-6 opacity-20"><Activity size={100}/></div>
               <div className="relative z-10">
                 <h1 className="text-2xl font-black mb-1">New Assignment</h1>
                 <p className="text-indigo-100 mb-6 text-sm font-medium opacity-80">Ready for verification</p>
               </div>
             </div>
             <TechnicianView onComplete={handleJobComplete} />
          </div>
        ) : (
          <div className="animate-in"><InvestorView jobs={jobs} /></div>
        )}
      </main>
    </div>
  );
};

const root = createRoot(document.getElementById('root'));
root.render(<App />);
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
